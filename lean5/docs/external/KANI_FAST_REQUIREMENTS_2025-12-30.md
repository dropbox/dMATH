# Lean5 Requirements from Kani Fast

**From:** Kani Fast (Rust verification engine) → eventually tRust (compiler)
**To:** Lean5 (theorem prover)
**Date:** 2025-12-30
**Status:** Requirements for Proof Generation Backend

## Summary

Kani Fast needs Lean5 as a **proof generation target**, not an interactive tool. When automatic verification (BMC, k-induction, CHC) fails to find an invariant, Kani Fast will generate Lean5 proof obligations that Lean5 must check.

**Key principle:** AI writes Rust, Kani Fast generates Lean5 proofs. No human writes proofs.

---

## Architecture Context

```
Rust code → Kani Fast → [BMC fails] → [K-ind fails] → [CHC fails]
                                                            ↓
                                              Generate Lean5 proof obligation
                                                            ↓
                                              Lean5 checks/completes proof
                                                            ↓
                                              Verified (or counterexample)
```

Eventually this becomes:
```
Rust code → tRust compiler → Kani Fast verification pass → Lean5 backend
```

---

## Priority 1: CRITICAL (Blocks Integration)

### 1.1 CLI Proof Checking

**What:** Check a proof file non-interactively.

**Required interface:**
```bash
lean5 --check proof.lean
# Exit 0 = proof valid
# Exit 1 = proof invalid (with error message)
```

### 1.2 Proof Obligation Format

Kani Fast will generate proof obligations in this format:

```lean
-- Auto-generated by Kani Fast
-- Property: no overflow in function `add_safe`

theorem add_safe_no_overflow (a b : UInt8)
  (h : a.toNat + b.toNat ≤ 255) :
  (a + b).toNat = a.toNat + b.toNat := by
  sorry  -- Kani Fast may fill this, or leave for Lean5 tactics

-- Kani Fast provides these facts from static analysis:
axiom kani_fact_1 : ∀ x : UInt8, x.toNat < 256
axiom kani_fact_2 : ...
```

**Required:** Lean5 must be able to:
1. Parse this format
2. Verify the theorem (if proof provided)
3. Report if `sorry` remains (incomplete proof)

### 1.3 Bitvector/Integer Support

Rust types map to Lean5 types:

| Rust | Lean5 |
|------|-------|
| `u8` | `UInt8` |
| `u16` | `UInt16` |
| `u32` | `UInt32` |
| `u64` | `UInt64` |
| `i32` | `Int32` (or `Int` with bounds) |
| `bool` | `Bool` |
| `[T; N]` | `Array T N` or `Fin N → T` |

**Required:** Standard library with these types and arithmetic operations.

### 1.4 Overflow Semantics

Rust has specific overflow behavior:
- Debug mode: panic
- Release mode: wrap

**Required:** Lean5 must support both semantics:
```lean
def checked_add (a b : UInt8) : Option UInt8 := ...
def wrapping_add (a b : UInt8) : UInt8 := ...
```

---

## Priority 2: HIGH (Automation)

### 2.1 Tactic for Common Patterns

Kani Fast generates proofs for common patterns. Lean5 should have tactics that handle:

```lean
-- Overflow checking
theorem no_overflow : a + b ≤ max → ... := by
  kani_overflow  -- Auto-solve overflow obligations

-- Bounds checking
theorem in_bounds : i < arr.size → ... := by
  kani_bounds  -- Auto-solve bounds obligations

-- Loop invariants
theorem loop_inv : ∀ n, P n → P (n+1) → ... := by
  kani_induction  -- Auto-solve induction
```

### 2.2 Proof Search Timeout

**Required:** Lean5 should have configurable timeout for proof search:
```bash
lean5 --check --timeout=60 proof.lean
```

### 2.3 Counterexample Extraction

When proof fails, provide concrete counterexample:
```
Error: theorem add_safe_no_overflow failed
Counterexample: a = 200, b = 100
  200 + 100 = 300 > 255, overflow occurs
```

---

## Priority 3: MEDIUM (Integration)

### 3.1 JSON Output Mode

For integration with Kani Fast:
```bash
lean5 --check --output=json proof.lean
```

```json
{
  "status": "error",
  "theorem": "add_safe_no_overflow",
  "message": "proof incomplete",
  "remaining_goals": ["⊢ a.toNat + b.toNat ≤ 255"]
}
```

### 3.2 Incremental Checking

Cache compiled proofs for incremental verification:
```bash
lean5 --check --cache=.lean_cache proof.lean
```

### 3.3 Proof Certificate Export

Export machine-checkable proof certificate:
```bash
lean5 --export-proof proof.lean -o proof.cert
```

---

## Integration with tRust

When Kani Fast is integrated into tRust:

```
tRust compiler
    ↓
Verification pass (Kani Fast as library)
    ↓
If complex property → Generate Lean5 proof obligation
    ↓
Call lean5 --check
    ↓
Report as compiler error if proof fails
```

**Required:** Fast startup time (<100ms) for lean5 invocation.

---

## Current Kani Fast Status

We're using Lean4 for now:
```bash
lean --version
lean4 file.lean
```

Kani Fast already has:
- Lean5 backend integration (invoke Lean compiler for proof checking)
- Tactic generation module
- Proof certificate generation

**Blocked on:** Lean5 CLI proof checking capability.

---

## Contact

- **Kani Fast repo:** https://github.com/dropbox/kani_fast
- **tRust repo:** https://github.com/dropbox/tRust
- **Proof generation code:** `crates/kani-fast-lean5/`
