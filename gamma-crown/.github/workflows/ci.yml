# CI for gamma-crown
#
# Runs on push to main and pull requests.
# Tests both Rust crates and Python bindings.

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Rust tests (fast, excludes gamma-onnx)
  rust-test:
    name: Rust Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
      - name: Run tests (excluding slow ONNX tests)
        run: cargo test --workspace --exclude gamma-onnx
      - name: Check clippy
        run: cargo clippy --all-targets -- -D warnings
      - name: Check formatting
        run: cargo fmt --all -- --check

  # Python tests
  python-test:
    name: Python Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
      - name: Install maturin
        run: pip install maturin pytest numpy
      - name: Build and install gamma
        working-directory: crates/gamma-python
        run: maturin develop
      - name: Run Python tests
        working-directory: crates/gamma-python
        run: pytest tests/ -v
      - name: Type check
        run: |
          pip install mypy
          cd crates/gamma-python
          mypy -c "import gamma; result = gamma.diff('a', 'b')" --ignore-missing-imports || true

  # Build check (all platforms)
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
      - name: Build release
        run: cargo build --release --workspace
